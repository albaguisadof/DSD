<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Agente</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="estilo.css">
  </head>
  <body>
    <h1>Sistema domótico : Agente</h1>
    <div id="formulario">
      <div>
        <p>Máximo de luminosidad actual: <span id="MAXluminosidad"></span></p>
        <label for="luminosidad">Modificar:</label>
        <input type="number" id="luminosidad" />
        <button  id="BotonMAXLuz">Cambiar MAX Luminosidad</button>
      </div>
      <div>
        <p>Máximo de temperatura actual: <span id="MAXtemperatura"></span></p>
        <label for="maxTemp">Modificar:</label>
        <input type="number" id="maxTemp" />
        <button id="BotonMAXT">Cambiar MAX Luminosidad</button>
      </div>
      <div>
        <p>Mínimo de temperatura actual: <span id="MINtemperatura"></span></p>
        <label for="minTemp">Modificar:</label>
        <input type="number" id="minTemp" />
        <button id="BotonMINT">Cambiar MIN Luminosidad</button>
      </div>
    </div>

    <div id="alarmas"></div>

    <script type="text/javascript">
        
        var serviceURL = document.URL;
        var socket = io.connect(serviceURL);

        //Variables de estado
        var luz = "Sin registrar";
        var temp = "Sin registrar";
        var maxluz = 50;
        var maxtemp = 25;
        var mintemp = 15;
        var persiana = "Subida";
        var AC = "Apagado";

        //Registramos cambios de valores de los umbrales
        var BotonMAXLuz = document.getElementById("BotonMAXLuz");
        var BotonMAXT = document.getElementById("BotonMAXT");
        var BotonMINT = document.getElementById("BotonMINT");

        BotonMAXLuz.addEventListener("click", enviarMAXLuminosidad);
        BotonMAXT.addEventListener("click", enviarMAXTemperatura);
        BotonMINT.addEventListener("click", enviarMINTemperatura);

        function enviarMAXLuminosidad(event) {
            event.preventDefault(); 
            var luminosidad = document.getElementById("luminosidad").value;
            var d = new Date();
            socket.emit('addMAXLuminosidad', {maxLuminosidad: luminosidad, time: d});
            maxluz = luminosidad;
        }

        function enviarMAXTemperatura(event) {
            event.preventDefault(); 
            var temperatura = document.getElementById("maxTemp").value;
            var d = new Date();
            socket.emit('addMAXTemperatura', {maxtemperatura: temperatura, time: d});
            maxtemp = temperatura;
        }

        function enviarMINTemperatura(event) {
            event.preventDefault(); 
            var temperatura = document.getElementById("minTemp").value;
            var d = new Date();
            socket.emit('addMINTemperatura', {mintemperatura: temperatura, time: d});
            mintemp = temperatura;
        }

        //gestionamos las alarmas necesarias
        function gestionar(){
            if(temp >= maxtemp){
                socket.emit('addAlarma', {alarma: "Se ha sobrepasado el umbral de luminosidad"});
            }

            if(luz >= maxluz){
                socket.emit('addAlarma', {alarma: "Se ha sobrepasado el umbral de temperatura "});
            }

            if(luz >= maxluz && temp >= maxtemp && persiana == "Subida"){
                socket.emit('addPersiana', {persiana: "Bajada"})
                socket.emit('addAlarma', {alarma: "Se ha bajado la persiana automaticamente"});
            }

            if(luz < maxluz && temp < maxtemp && persiana == "Bajada"){
                socket.emit('addPersiana', {persiana: "Subida"})
                socket.emit('addAlarma', {alarma: "Se ha subido la persiana automaticamente"});
            }
        }

        

        //actualizamos los datos
        function actualizar(data){

            if(data['temperatura']){
                temp = data['temperatura']
            };

            if(data['luminosidad']){
                luz = data['luminosidad']
            };

            if(data['persiana']){
                persiana = data['persiana']
            };

            if(data['AC']){
                AC = data['AC']
            };

            if(data['mintemperatura']){
                mintemp = data['mintemperatura'];
                document.getElementById('MINtemperatura').innerText  = mintemp;
            }

            if(data['maxtemperatura']){
                maxtemp = data['maxtemperatura'];
                document.getElementById('MAXtemperatura').innerText  = maxtemp;
            }

            if(data['maxLuminosidad']){
                maxluz = data['maxLuminosidad'];
                document.getElementById('MAXLuminosidad').innerText  = maxluz;
            }

            gestionar();
        }

        socket.on('actualizar', function(data) {
            actualizar(data);
        })
        
      
    </script>
  </body>
</html>
